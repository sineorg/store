name: Update marketplace

on:
  schedule:
    - cron: "*/7 * * * *"
  workflow_dispatch:
    inputs:
      mod_id:
        description: "Custom mod id to process"
        required: false
  workflow_call:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl gh

      - name: Ensure marketplace.json exists
        run: |
          if [[ ! -f marketplace.json ]]; then
            echo '{}' > marketplace.json
          fi

      - name: Ensure meta.json exists
        run: |
          if [[ ! -f meta.json ]]; then
            echo '{}' > meta.json
          fi

      # ─────────────────────────────────────────────
      # Pick NEXT mod via cursor
      # ─────────────────────────────────────────────
      - name: Select next mod
        id: pick
        run: |
          next_mod=$(
            jq -r '
              # Load inputs
              (input | .cursor // "") as $cursor
              | (keys | sort) as $keys
      
              | if ($keys | length) == 0 then
                  empty
                elif $cursor == "" then
                  $keys[0]
                else
                  ($keys | index($cursor)) as $i
                  | if $i == null then
                      $keys[0]
                    else
                      $keys[($i + 1) % ($keys | length)]
                    end
                end
            ' marketplace.json meta.json
          )
      
          if [ -n "${{ github.event.inputs.mod_id }}" ]; then
            next_mod="${{ github.event.inputs.mod_id }}"
          fi
      
          echo "modId=$next_mod" >> "$GITHUB_OUTPUT"
          echo "branch=bot/mod/$next_mod" >> "$GITHUB_OUTPUT"
      
          echo "Selected mod: $next_mod"

      - name: Commit cursor progress and sort
        run: |
          modId="${{ steps.pick.outputs.modId }}"
      
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      
          # Advance cursor
          jq --arg mod "$modId" '
            .cursor = $mod
          ' meta.json > tmp.json && mv tmp.json meta.json
      
          # Sort marketplace by stars
          jq '
            to_entries
            | sort_by(.value.stars // 0)
            | reverse
            | from_entries
          ' marketplace.json > tmp.json && mv tmp.json marketplace.json
      
          git add marketplace.json meta.json
      
          if git diff --cached --quiet; then
            echo "Cursor already up to date"
            exit 0
          fi
      
          git commit -m "Advance marketplace cursor to $modId"
          git push origin main

      - name: Checkout mod branch
        id: branch
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="bot/mod/$modId"

          git fetch origin "$branch" || true

          if git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            git checkout "$branch"
            git pull --ff-only origin "$branch"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            git checkout -b "$branch"
          fi

      # ─────────────────────────────────────────────
      # Process ONE mod
      # ─────────────────────────────────────────────
      - name: Process mod
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          modId="${{ steps.pick.outputs.modId }}"
          echo "Processing mod: $modId"

          mkdir -p "mods/$modId"

          homepage=$(jq -r ".\"$modId\".homepage // empty" marketplace.json)
          if [[ -z "$homepage" ]]; then
            echo "No homepage for $modId"
            exit 0
          fi

          # Normalize homepage → GitHub URL
          if [[ "$homepage" =~ ^https?:// ]]; then
            :
          elif [[ "$homepage" =~ ^github\.com/ ]]; then
            homepage="https://$homepage"
          else
            homepage="https://github.com/$homepage"
          fi

          repo=""
          branch="main"
          subpath=""
          
          if [[ "$homepage" =~ github\.com/([^/]+/[^/]+)(/tree/([^/]+)(/(.*))?)? ]]; then
            repo="${BASH_REMATCH[1]}"
            branch="${BASH_REMATCH[3]:-main}"
            subpath="${BASH_REMATCH[5]}"
          fi
          
          if [[ -z "$repo" ]]; then
            echo "Could not resolve GitHub repo for $modId"
            exit 0
          fi
          
          theme_json=""
          
          if [[ -n "$subpath" ]]; then
            url="https://raw.githubusercontent.com/$repo/$branch/$subpath/theme.json"
            theme_json=$(curl -fsSL "$url" || true)
          else
            for b in "$branch" main master; do
              url="https://raw.githubusercontent.com/$repo/$b/theme.json"
              if theme_json=$(curl -fsSL "$url"); then
                break
              fi
            done
          fi
          
          if [[ -z "$theme_json" ]]; then
            echo "No theme.json found for $modId"
            exit 0
          fi
          
          echo "$theme_json" | jq . >/dev/null

          # ─── Fetch stars ─────────────────────────────
          stars=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "User-Agent: marketplace-bot" \
            "https://api.github.com/repos/$repo" \
            | jq -r '.stargazers_count // 0')

          # ─── Download ZIP (once per run) ─────────────
          for branch in main master; do
            zip_url="https://codeload.github.com/$repo/zip/refs/heads/$branch"
            if curl -fsSL "$zip_url" -o "mods/$modId/mod.zip"; then
              break
            fi
          done

          # ─── Update marketplace entry ────────────────
          jq \
            --arg mod "$modId" \
            --argjson stars "$stars" \
            --argjson theme "$theme_json" '
              .[$mod] =
                ($theme + {
                  stars: $stars,
                  id: $mod,
                  homepage: ($theme.homepage // null)
                })
            ' marketplace.json > tmp.json && mv tmp.json marketplace.json

      
      # ─────────────────────────────────────────────
      # Commit + push
      # ─────────────────────────────────────────────
      - name: Commit and push
        id: commit
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="bot/mod/$modId"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add marketplace.json "mods/$modId"

          if git diff --cached --quiet; then
            echo "committed=false" >> "$GITHUB_OUTPUT"
            echo "No changes for $modId"
            exit 0
          fi

          git commit -m "Update mod $modId"
          git push -u origin "$branch"

          echo "committed=true" >> "$GITHUB_OUTPUT"

      # ─────────────────────────────────────────────
      # Create PR if missing
      # ────────────────────────────────────────────
      - name: Create PR if missing
        if: steps.branch.outputs.exists == 'false' && steps.commit.outputs.committed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="bot/mod/$modId"

          homepage=$(jq -r ".\"$modId\".homepage // empty" marketplace.json)
          if [[ -n "$homepage" && ! "$homepage" =~ ^https?:// ]]; then
            homepage="https://github.com/$homepage"
          fi
          body="Automated update for [$modId]($homepage)."

          gh pr create \
            --repo "$GITHUB_REPOSITORY" \
            --title "Add / update mod: $modId" \
            --body "$body" \
            --base main \
            --head "$branch"

  call-update:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    uses: ./.github/workflows/update-marketplace.yml
