name: Update marketplace

on:
  workflow_dispatch:
    inputs:
      mod_id:
        description: "Custom mod id to process"
        required: false
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    if: >
      github.event_name != 'pull_request' ||
      github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl gh

      - name: Ensure marketplace.json exists
        run: |
          if [[ ! -f marketplace.json ]]; then
            echo '{}' > marketplace.json
          fi

      - name: Ensure meta.json exists
        run: |
          if [[ ! -f meta.json ]]; then
            echo '{}' > meta.json
          fi

      - name: Select next mod
        id: pick
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] && \
             [ "${{ github.event.pull_request.merged }}" = "true" ]; then
      
            branch="${{ github.event.pull_request.head.ref }}"
            next_mod="${branch#mod/}"
      
            echo "Using mod from merged PR: $next_mod"
      
          else
            next_mod=$(
              jq -r '
                (input | .cursor // "") as $cursor
                | (keys | sort) as $keys
      
                | if ($keys | length) == 0 then
                    empty
                  elif $cursor == "" then
                    $keys[0]
                  else
                    ($keys | index($cursor)) as $i
                    | if $i == null then
                        $keys[0]
                      else
                        $keys[($i + 1) % ($keys | length)]
                      end
                  end
              ' marketplace.json meta.json
            )
      
            if [ -n "${{ github.event.inputs.mod_id }}" ]; then
              next_mod="${{ github.event.inputs.mod_id }}"
            fi
          fi
      
          echo "modId=$next_mod" >> "$GITHUB_OUTPUT"
          echo "branch=mod/$next_mod" >> "$GITHUB_OUTPUT"
          echo "Selected mod: $next_mod"

      - name: Commit cursor progress
        run: |
          modId="${{ steps.pick.outputs.modId }}"
      
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git config pull.rebase false

          git pull origin main
      
          # Advance cursor
          jq --arg mod "$modId" '
            .cursor = $mod
          ' meta.json > tmp.json && mv tmp.json meta.json
      
          git add meta.json
      
          if git diff --cached --quiet; then
            echo "Cursor already up to date"
            exit 0
          fi
      
          git commit -m "Advance marketplace cursor to $modId"
          git push origin main

      - name: Resolve GitHub repo and theme info
        id: resolve_theme
        shell: bash
        run: |
          modId="${{ steps.pick.outputs.modId }}"
      
          # Get homepage from marketplace.json
          homepage=$(jq -r ".\"$modId\".homepage // empty" marketplace.json)
          if [[ -z "$homepage" ]]; then
            echo "No homepage for $modId"
            exit 0
          fi
      
          # Normalize homepage → GitHub URL
          if [[ "$homepage" =~ ^https?:// ]]; then
            :
          elif [[ "$homepage" =~ ^github\.com/ ]]; then
            homepage="https://$homepage"
          else
            homepage="https://github.com/$homepage"
          fi
      
          repo=""
          branch="main"
          subpath=""
      
          if [[ "$homepage" =~ github\.com/([^/]+/[^/]+)(/tree/([^/]+)(/(.*))?)? ]]; then
            repo="${BASH_REMATCH[1]}"
            branch="${BASH_REMATCH[3]:-main}"
            subpath="${BASH_REMATCH[5]}"
          fi
      
          if [[ -z "$repo" ]]; then
            echo "Could not resolve GitHub repo for $modId"
            exit 0
          fi
      
          theme_json=""
      
          if [[ -n "$subpath" ]]; then
            url="https://raw.githubusercontent.com/$repo/$branch/$subpath/theme.json"
            theme_json=$(curl -fsSL "$url" || true)
          else
            for b in "$branch" main master; do
              url="https://raw.githubusercontent.com/$repo/$b/theme.json"
              if theme_json=$(curl -fsSL "$url"); then
                break
              fi
            done
          fi
      
          if [[ -z "$theme_json" ]]; then
            echo "No theme.json found for $modId"
            exit 0
          fi
      
          # Validate theme_json
          echo "$theme_json" | jq . >/dev/null
      
          # Export variables to GitHub Actions environment
          echo "repo=$repo" >> $GITHUB_ENV
          echo "branch=$branch" >> $GITHUB_ENV
          echo "subpath=$subpath" >> $GITHUB_ENV
          echo "homepage=$homepage" >> $GITHUB_ENV
          {
            echo "theme_json<<EOF"
            echo "$theme_json"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Update stars for mod and sort
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          modId="${{ steps.pick.outputs.modId }}"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git config pull.rebase false

          git pull origin main

          # Fetch stars for current mod
          stars=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "User-Agent: marketplace-bot" \
            "https://api.github.com/repos/$repo" \
            | jq -r '.stargazers_count // 0')

          # Update marketplace entry
          jq \
            --arg mod "$modId" \
            --argjson stars "$stars" \
            '.[$mod].stars = $stars' \
            marketplace.json > tmp.json && mv tmp.json marketplace.json
            
          theme_json=$(
            jq -c \
              --argjson stars "$stars" \
              '.stars = $stars' \
              <<<"$theme_json"
          )
          {
            echo "theme_json<<EOF"
            echo "$theme_json"
            echo "EOF"
          } >> "$GITHUB_ENV"
      
          # Sort marketplace by stars
          jq '
            to_entries
            | sort_by(.value.stars // 0)
            | reverse
            | from_entries
          ' marketplace.json > tmp.json && mv tmp.json marketplace.json
      
          git add marketplace.json
      
          if git diff --cached --quiet; then
            echo "Cursor already up to date"
            exit 0
          fi
      
          git commit -m "Update stars for $modId"
          git push origin main

      - name: Checkout mod branch
        id: branch
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          gitBranch="mod/$modId"

          git fetch origin "$gitBranch" || true

          if git show-ref --verify --quiet "refs/remotes/origin/$gitBranch"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            git checkout "$gitBranch"
            git pull --ff-only origin "$gitBranch"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            git checkout -b "$gitBranch"
          fi

      - name: Process mod
        run: |
          set -euo pipefail

          modId="${{ steps.pick.outputs.modId }}"
          echo "Processing mod: $modId"

          mkdir -p "mods/$modId"

          # ─── Download ZIP (once per run) ─────────────
          for branch in main master; do
            zip_url="https://codeload.github.com/$repo/zip/refs/heads/$branch"
            if curl -fsSL "$zip_url" -o "mods/$modId/mod.zip"; then
              break
            fi
          done

          # ─── Update marketplace entry ────────────────
          jq \
            --arg mod "$modId" \
            --argjson theme "$theme_json" '
              .[$mod] =
                ($theme + {
                  id: $mod,
                  homepage: ($theme.homepage // null)
                })
            ' marketplace.json > tmp.json && mv tmp.json marketplace.json

      - name: Commit and push
        id: commit
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="mod/$modId"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git config pull.rebase false

          git pull origin main

          git add marketplace.json "mods/$modId"

          if git diff --cached --quiet; then
            echo "committed=false" >> "$GITHUB_OUTPUT"
            echo "No changes for $modId"
            exit 0
          fi

          git commit -m "Update mod $modId"
          git push -u origin "$branch"

          echo "committed=true" >> "$GITHUB_OUTPUT"

      - name: Create PR if missing
        if: steps.branch.outputs.exists == 'false' && steps.commit.outputs.committed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="mod/$modId"

          homepage=$(jq -r ".\"$modId\".homepage // empty" marketplace.json)
          if [[ -n "$homepage" && ! "$homepage" =~ ^https?:// ]]; then
            homepage="https://github.com/$homepage"
          fi
          body="Automated update for [$modId]($homepage)."

          gh pr create \
            --repo "$GITHUB_REPOSITORY" \
            --title "Add / update mod: $modId" \
            --body "$body" \
            --base main \
            --head "$branch"
