name: Update Marketplace

on:
  schedule:
    - cron: "*/7 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Ensure marketplace.json exists
        run: |
          if [[ ! -f marketplace.json ]]; then
            echo '{}' > marketplace.json
          fi

      # ─────────────────────────────────────────────
      # Determine next mod using cursor
      # ─────────────────────────────────────────────
      - name: Select next mod
        id: next
        run: |
          next_mod=$(
            jq -r '
              . as $root
              | keys
              | sort
              | map(select(. != "_meta"))
              | . as $keys
              | ($root._meta.cursor // "") as $cursor
              | if $cursor == ""
                then $keys[0]
                else
                  ($keys | index($cursor) + 1) as $i
                  | if $i < length then $keys[$i] else empty end
                end
            ' marketplace.json
          )

          echo "next_mod=$next_mod" >> "$GITHUB_OUTPUT"

          if [[ -z "$next_mod" ]]; then
            echo "All mods processed"
          else
            echo "Next mod: $next_mod"
          fi

      - name: Stop if complete
        if: steps.next.outputs.next_mod == ''
        run: exit 0

      # ─────────────────────────────────────────────
      # Process exactly ONE mod
      # ─────────────────────────────────────────────
      - name: Process mod
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          modId="${{ steps.next.outputs.next_mod }}"
          echo "Processing mod: $modId"

          homepage=$(jq -r ".\"$modId\".homepage // empty" marketplace.json)
          if [[ -z "$homepage" ]]; then
            echo "No homepage for $modId"
            exit 0
          fi

          if [[ "$homepage" =~ github\.com/([^/]+/[^/]+) ]]; then
            repo="${BASH_REMATCH[1]}"
          else
            echo "Non-GitHub homepage, skipping ZIP"
            repo=""
          fi

          # ─── Fetch stars ──────────────────────────
          stars=0
          if [[ -n "$repo" ]]; then
            stars=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "User-Agent: marketplace-bot" \
              "https://api.github.com/repos/$repo" \
              | jq -r '.stargazers_count // 0')
          fi

          # ─── Download mod.zip ─────────────────────
          if [[ -n "$repo" ]]; then
            mkdir -p "mods/$modId"

            if [[ ! -f "mods/$modId/mod.zip" ]]; then
              for branch in main master; do
                zip_url="https://codeload.github.com/$repo/zip/refs/heads/$branch"
                if curl -L --retry 3 --retry-delay 5 "$zip_url" -o "mods/$modId/mod.zip"; then
                  break
                fi
              done
            fi
          fi

          # ─── Update marketplace entry ─────────────
          jq --arg mod "$modId" --argjson stars "$stars" '
            .[$mod] |= (. + { stars: $stars })
          ' marketplace.json > tmp.json && mv tmp.json marketplace.json

          # ─── Advance cursor ───────────────────────
          jq --arg mod "$modId" '
            ._meta.cursor = $mod
          ' marketplace.json > tmp.json && mv tmp.json marketplace.json

      - name: Commit and push changes
        run: |
          set -e
      
          git config user.name "marketplace-bot"
          git config user.email "marketplace-bot@users.noreply.github.com"
      
          # Always switch to bot branch
          git checkout -B bot/update-marketplace

          mkdir -p mods
          git add marketplace.json mods/
      
          if git diff --cached --quiet; then
            echo "No changes to commit (skipping PR creation)"
            exit 0
          fi
      
          git commit -m "Incremental marketplace update"
          git push -f origin bot/update-marketplace
      
      - name: Create or update pull request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
      
          # Check if PR already exists
          if gh pr list --head bot/update-marketplace --json number --jq 'length > 0'; then
            echo "PR already exists — updated via push"
            exit 0
          fi
      
          echo "Creating pull request targeting cosine"
      
          gh pr create \
            --title "Incremental marketplace update" \
            --body "Automated incremental update (one mod per run)." \
            --base cosine \
            --head bot/update-marketplace
