name: Update marketplace

on:
  schedule:
    - cron: "*/7 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl gh

      - name: Ensure marketplace.json exists
        run: |
          if [[ ! -f marketplace.json ]]; then
            echo '{}' > marketplace.json
          fi

      # ─────────────────────────────────────────────
      # Pick NEXT mod via cursor
      # ─────────────────────────────────────────────
      - name: Select next mod
        id: pick
        run: |
          next_mod=$(
            jq -r '
              . as $root
              | keys
              | sort
              | map(select(. != "_meta"))
              | . as $keys
              | ($root._meta.cursor // "") as $cursor
              | if ($keys | length) == 0 then empty
                elif $cursor == "" then $keys[0]
                else
                  ($keys | index($cursor)) as $i
                  | if $i == null then $keys[0]
                    else $keys[($i + 1) % ($keys | length)]
                    end
                end
            ' marketplace.json
          )

          echo "modId=$next_mod" >> "$GITHUB_OUTPUT"
          echo "branch=bot/mod/$next_mod" >> "$GITHUB_OUTPUT"

          echo "Selected mod: $next_mod"

      - name: Commit cursor progress
        run: |
          modId="${{ steps.pick.outputs.modId }}"
      
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      
          # Advance cursor ONLY
          jq --arg mod "$modId" '
            ._meta.cursor = $mod
          ' marketplace.json > tmp.json && mv tmp.json marketplace.json
      
          git add marketplace.json
      
          if git diff --cached --quiet; then
            echo "Cursor already up to date"
            exit 0
          fi
      
          git commit -m "Advance marketplace cursor to $modId"
          git push origin main

      - name: Checkout mod branch
        id: branch
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="bot/mod/$modId"

          git fetch origin "$branch" || true

          if git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            git checkout "$branch"
            git pull --ff-only origin "$branch"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            git checkout -b "$branch"
          fi

      # ─────────────────────────────────────────────
      # Process ONE mod
      # ─────────────────────────────────────────────
      - name: Process mod
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          modId="${{ steps.pick.outputs.modId }}"
          echo "Processing mod: $modId"

          mkdir -p "mods/$modId"

          homepage=$(jq -r ".\"$modId\".homepage // empty" marketplace.json)
          if [[ -z "$homepage" ]]; then
            echo "No homepage for $modId"
            exit 0
          fi

          repo=""
          
          if [[ "$homepage" =~ github\.com/([^/]+/[^/]+) ]]; then
            # Matches https://github.com/user/repo (and similar)
            repo="${BASH_REMATCH[1]}"
          
          elif [[ "$homepage" =~ ^([^/]+/[^/]+)$ ]]; then
            # Matches plain user/repo
            repo="${BASH_REMATCH[1]}"
          fi

          # ─── Fetch stars ──────────────────────────
          stars=0
          if [[ -n "$repo" ]]; then
            stars=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "User-Agent: marketplace-bot" \
              "https://api.github.com/repos/$repo" \
              | jq -r '.stargazers_count // 0')
          fi

          # ─── Download ZIP (once) ──────────────────
          if [[ -n "$repo" ]]; then
            for branch in main master; do
              zip_url="https://codeload.github.com/$repo/zip/refs/heads/$branch"
              if curl -L --retry 3 --retry-delay 5 "$zip_url" -o "mods/$modId/mod.zip"; then
                break
              fi
            done
          fi

          # ─── Update marketplace entry ─────────────
          jq --arg mod "$modId" --argjson stars "$stars" '
            .[$mod] |= (. + { stars: $stars })
          ' marketplace.json > tmp.json && mv tmp.json marketplace.json

          # ─── Advance cursor ───────────────────────
          jq --arg mod "$modId" '
            ._meta.cursor = $mod
          ' marketplace.json > tmp.json && mv tmp.json marketplace.json

      # ─────────────────────────────────────────────
      # Commit + push
      # ─────────────────────────────────────────────
      - name: Commit and push
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="${{ steps.pick.outputs.branch }}"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add marketplace.json "mods/$modId"

          if git diff --cached --quiet; then
            echo "No changes for $modId"
            exit 0
          fi

          git commit -m "Update mod $modId"
          git push -u origin "$branch"

      # ─────────────────────────────────────────────
      # Create PR if missing
      # ────────────────────────────────────────────
      - name: Create PR if missing
        if: steps.branch.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="bot/mod/$modId"

          gh pr create \
            --repo "$GITHUB_REPOSITORY" \
            --title "Add / update mod: $modId" \
            --body "Automated update for mod **$modId**." \
            --base main \
            --head "$branch"
