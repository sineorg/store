name: Update Marketplace

on:
  schedule:
    - cron: "*/7 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl gh

      - name: Ensure marketplace.json exists
        run: |
          if [[ ! -f marketplace.json ]]; then
            echo '{}' > marketplace.json
          fi

      # ─────────────────────────────────────────────
      # Pick NEXT mod via cursor
      # ─────────────────────────────────────────────
      - name: Select next mod
        id: pick
        run: |
          next_mod=$(
            jq -r '
              . as $root
              | keys
              | sort
              | map(select(. != "_meta"))
              | . as $keys
              | ($root._meta.cursor // "") as $cursor
              | if $cursor == ""
                then $keys[0]
                else
                  ($keys | index($cursor) + 1) as $i
                  | if $i < length then $keys[$i] else empty end
                end
            ' marketplace.json
          )

          if [[ -z "$next_mod" ]]; then
            echo "All mods processed"
            exit 1
          fi

          echo "modId=$next_mod" >> "$GITHUB_OUTPUT"
          echo "branch=bot/mod/$next_mod" >> "$GITHUB_OUTPUT"

          echo "Selected mod: $next_mod"

      - name: Checkout mod branch
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="${{ steps.pick.outputs.branch }}"

          git fetch origin "$branch" || true

          if git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
            git checkout "$branch"
            git pull --ff-only origin "$branch"
          else
            git checkout -b "$branch"
          fi

      - name: Commit cursor progress
        run: |
          modId="${{ steps.pick.outputs.modId }}"

          git config user.name "marketplace-bot"
          git config user.email "marketplace-bot@users.noreply.github.com"

          # Ensure we're on the workflow branch
          git checkout cosine

          # Advance cursor ONLY
          jq --arg mod "$modId" '
            ._meta.cursor = $mod
          ' marketplace.json > tmp.json && mv tmp.json marketplace.json

          git add marketplace.json

          if git diff --cached --quiet; then
            echo "Cursor already up to date"
            exit 0
          fi

          git commit -m "Advance marketplace cursor to $modId"
          git push origin cosine

      # ─────────────────────────────────────────────
      # Process ONE mod
      # ─────────────────────────────────────────────
      - name: Process mod
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          modId="${{ steps.pick.outputs.modId }}"
          echo "Processing mod: $modId"

          mkdir -p "mods/$modId"

          homepage=$(jq -r ".\"$modId\".homepage // empty" marketplace.json)
          if [[ -z "$homepage" ]]; then
            echo "No homepage for $modId"
            exit 0
          fi

          repo=""
          if [[ "$homepage" =~ github\.com/([^/]+/[^/]+) ]]; then
            repo="${BASH_REMATCH[1]}"
          fi

          # ─── Fetch stars ──────────────────────────
          stars=0
          if [[ -n "$repo" ]]; then
            stars=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "User-Agent: marketplace-bot" \
              "https://api.github.com/repos/$repo" \
              | jq -r '.stargazers_count // 0')
          fi

          # ─── Download ZIP (once) ──────────────────
          if [[ -n "$repo" && ! -f "mods/$modId/mod.zip" ]]; then
            for branch in main master; do
              zip_url="https://codeload.github.com/$repo/zip/refs/heads/$branch"
              if curl -L --retry 3 --retry-delay 5 "$zip_url" -o "mods/$modId/mod.zip"; then
                break
              fi
            done
          fi

          # ─── Update marketplace entry ─────────────
          jq --arg mod "$modId" --argjson stars "$stars" '
            .[$mod] |= (. + { stars: $stars })
          ' marketplace.json > tmp.json && mv tmp.json marketplace.json

      # ─────────────────────────────────────────────
      # Commit + push
      # ─────────────────────────────────────────────
      - name: Commit and push
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="${{ steps.pick.outputs.branch }}"

          git config user.name "marketplace-bot"
          git config user.email "marketplace-bot@users.noreply.github.com"

          git add marketplace.json "mods/$modId"

          if git diff --cached --quiet; then
            echo "No changes for $modId"
            exit 0
          fi

          git commit -m "Update mod $modId"
          git push -u origin "$branch"

      # ─────────────────────────────────────────────
      # Create PR if missing
      # ─────────────────────────────────────────────
      - name: Create PR if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          modId="${{ steps.pick.outputs.modId }}"
          branch="${{ steps.pick.outputs.branch }}"

          existing_pr=$(gh pr list \
            --repo "$GITHUB_REPOSITORY" \
            --head "$GITHUB_REPOSITORY:$branch" \
            --base cosine \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [[ -n "$existing_pr" ]]; then
            echo "PR #$existing_pr already exists for $modId"
          else
            gh pr create \
              --repo "$GITHUB_REPOSITORY" \
              --title "Add / update mod: $modId" \
              --body "Automated update for mod **$modId**." \
              --base cosine \
              --head "$branch"
          fi